<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.king.configuration.merge.mapper.MergeRecordMapper">

    <!-- 根据部署ID查询发版登记详情（带关联信息） -->
    <select id="selectDeployRecordDetailById" parameterType="java.lang.Integer" resultType="com.king.configuration.merge.entity.TfDeployRecord">
        SELECT
            dr.DEPLOY_ID,
            dr.TEST_STAGE,
            dr.SYSTEM_ID,
            dr.COMPONENT_INFO,
            dr.VERSION_CODE,
            dr.RECORD_NUM,
            dr.CODE_LIST,
            dr.IS_RUN_SQL,
            dr.IS_UPDATE_CONFIG,
            dr.DEPLOY_TIME,
            dr.SEND_TEST_INFO,
            ts.SYSTEM_NAME
        FROM tf_deploy_record dr
        LEFT JOIN t_test_system ts ON dr.SYSTEM_ID = ts.SYSTEM_ID
        WHERE dr.DEPLOY_ID = #{deployId}
    </select>

    <!-- 分页查询发版登记列表（带系统名称） -->
    <select id="selectDeployRecordListWithSystemName" resultType="com.king.configuration.merge.entity.TfDeployRecord">
        SELECT
            dr.DEPLOY_ID,
            dr.TEST_STAGE,
            dr.SYSTEM_ID,
            dr.COMPONENT_INFO,
            dr.VERSION_CODE,
            dr.RECORD_NUM,
            dr.CODE_LIST,
            dr.IS_RUN_SQL,
            dr.IS_UPDATE_CONFIG,
            dr.DEPLOY_TIME,
            dr.SEND_TEST_INFO,
            ts.SYSTEM_NAME
        FROM tf_deploy_record dr
        LEFT JOIN t_test_system ts ON dr.SYSTEM_ID = ts.SYSTEM_ID
        <where>
            <if test="sendTestInfo != null and sendTestInfo != ''">
                AND dr.SEND_TEST_INFO LIKE CONCAT('%', #{sendTestInfo}, '%')
            </if>
            <if test="systemName != null and systemName != ''">
                AND ts.SYSTEM_NAME LIKE CONCAT('%', #{systemName}, '%')
            </if>
            <if test="testStage != null and testStage != ''">
                AND dr.TEST_STAGE = #{testStage}
            </if>
            <if test="startDate != null and startDate != ''">
                AND DATE(dr.DEPLOY_TIME) &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND DATE(dr.DEPLOY_TIME) &lt;= #{endDate}
            </if>
        </where>
        ORDER BY dr.DEPLOY_ID DESC
    </select>

    <!-- 查询当天同一系统同一测试阶段的最后一条记录（按部署时间倒序） -->
    <select id="selectLastDeployRecordBySystemAndStageAndDate" resultType="com.king.configuration.merge.entity.TfDeployRecord">
        SELECT
            dr.DEPLOY_ID,
            dr.TEST_STAGE,
            dr.SYSTEM_ID,
            dr.COMPONENT_INFO,
            dr.VERSION_CODE,
            dr.RECORD_NUM,
            dr.CODE_LIST,
            dr.IS_RUN_SQL,
            dr.IS_UPDATE_CONFIG,
            dr.DEPLOY_TIME,
            dr.SEND_TEST_INFO
        FROM tf_deploy_record dr
        WHERE dr.SYSTEM_ID = #{systemId}
          AND dr.TEST_STAGE = #{testStage}
          AND DATE_FORMAT(dr.DEPLOY_TIME, '%Y%m%d') = #{dateStr}
        ORDER BY dr.DEPLOY_TIME DESC
        LIMIT 1
    </select>

</mapper>

