<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.king.test.bugManage.mapper.TfBugMapper">

    <sql id="CommonCondition">
        <if test="systemId != null and systemId != ''">
            AND b.SYSTEM_ID = #{systemId}
        </if>
        <if test="directoryIds != null and directoryIds.size() > 0">
            AND b.DIRECTORY_ID IN
            <foreach collection="directoryIds" item="directoryId" open="(" close=")" separator=",">
                #{directoryId}
            </foreach>
        </if>
        <if test="bugId != null and bugId != ''">
            AND (b.BUG_ID LIKE CONCAT('%', #{bugId}, '%') OR CAST(b.BUG_ID AS CHAR) LIKE CONCAT('%', #{bugId}, '%'))
        </if>
        <if test="bugName != null and bugName != ''">
            AND b.BUG_NAME LIKE CONCAT('%', #{bugName}, '%')
        </if>
        <if test="bugState != null and bugState != ''">
            AND b.BUG_STATE = #{bugState}
        </if>
        <if test="bugType != null and bugType != ''">
            AND b.BUG_TYPE = #{bugType}
        </if>
        <if test="bugSeverityLevel != null">
            AND b.BUG_SEVERITY_LEVEL = #{bugSeverityLevel}
        </if>
        <if test="bugSource != null and bugSource != ''">
            AND b.BUG_SOURCE = #{bugSource}
        </if>
        <if test="submitterId != null and submitterId != ''">
            AND b.SUBMITTER_ID = #{submitterId}
        </if>
        <if test="checkerId != null and checkerId != ''">
            AND b.CHECKER_ID = #{checkerId}
        </if>
        <if test="developerId != null and developerId != ''">
            AND b.DEVELOPER_ID = #{developerId}
        </if>
        <if test="commitTimeStart != null and commitTimeStart != ''">
            AND b.COMMIT_TIME &gt;= #{commitTimeStart}
        </if>
        <if test="commitTimeEnd != null and commitTimeEnd != ''">
            AND b.COMMIT_TIME &lt;= #{commitTimeEnd}
        </if>
        <if test="closeTimeStart != null and closeTimeStart != ''">
            AND b.CLOSE_TIME &gt;= #{closeTimeStart}
        </if>
        <if test="closeTimeEnd != null and closeTimeEnd != ''">
            AND b.CLOSE_TIME &lt;= #{closeTimeEnd}
        </if>
    </sql>

    <!-- 分页查询缺陷列表 -->
    <select id="selectPageBugList" resultType="com.king.test.bugManage.entity.TfBug">
        SELECT
            b.BUG_ID AS bugId,
            b.BUG_NAME AS bugName,
            b.SYSTEM_ID AS systemId,
            ts.SYSTEM_NAME AS systemName,
            b.BUG_STATE AS bugState,
            bs.BUG_STATE_NAME AS bugStateName,
            b.USECASE_ID AS usecaseId,
            b.BUG_SOURCE AS bugSource,
            dic_source.DATA_NAME AS bugSourceName,
            b.PRORITY AS prority,
            dic_priority.DATA_NAME AS prorityName,
            b.BUG_DESCRIPITION AS bugDescription,
            b.BUG_SEVERITY_LEVEL AS bugSeverityLevel,
            dic_severity.DATA_NAME AS bugSeverityLevelName,
            b.CLOSE_REASON AS closeReason,
            b.SUBMITTER_ID AS submitterId,
            submitter.USER_NAME AS submitterName,
            b.DEVELOPER_ID AS developerId,
            developer.USER_NAME AS developerName,
            b.DEV_LEADER_ID AS devLeaderId,
            dev_leader.USER_NAME AS devLeaderName,
            b.CHECKER_ID AS checkerId,
            checker.USER_NAME AS checkerName,
            b.BUG_TYPE AS bugType,
            dic_type.DATA_NAME AS bugTypeName,
            b.DIRECTORY_ID AS directoryId,
            b.COMMIT_TIME AS commitTime,
            b.CONFIRMED_TIME AS confirmedTime,
            b.ASSIGNED_TIME AS assignedTime,
            b.RESOLVED_TIME AS resolvedTime,
            b.WAITCHECK_TIME AS waitCheckTime,
            b.CLOSE_TIME AS closeTime,
            b.SOLVE_VOLUME AS solveVolume,
            b.SUBMITTED_VOLUME AS submittedVolume,
            b.BUG_WORKFLOW_ID AS bugWorkflowId
        FROM tf_bug b
        LEFT JOIN t_test_system ts ON b.SYSTEM_ID = ts.SYSTEM_ID
        LEFT JOIN t_sys_user submitter ON b.SUBMITTER_ID = submitter.USER_ID
        LEFT JOIN t_sys_user developer ON b.DEVELOPER_ID = developer.USER_ID
        LEFT JOIN t_sys_user dev_leader ON b.DEV_LEADER_ID = dev_leader.USER_ID
        LEFT JOIN t_sys_user checker ON b.CHECKER_ID = checker.USER_ID
        LEFT JOIN tf_bug_state bs ON bs.BUG_STATE_CODE = b.BUG_STATE
        LEFT JOIN data_dictionary dic_source ON dic_source.DATA_TYPE = 'bugSource' AND dic_source.DATA_VALUE = b.BUG_SOURCE
        LEFT JOIN data_dictionary dic_priority ON dic_priority.DATA_TYPE = 'prority' AND dic_priority.DATA_VALUE = b.PRORITY
        LEFT JOIN data_dictionary dic_severity ON dic_severity.DATA_TYPE = 'bugSeverityLevel' AND dic_severity.DATA_VALUE = CAST(b.BUG_SEVERITY_LEVEL AS CHAR)
        LEFT JOIN data_dictionary dic_type ON dic_type.DATA_TYPE = 'bugType' AND dic_type.DATA_VALUE = b.BUG_TYPE
        <if test="queryType != null and queryType == 'myActiveBugs' and currentUserId != null and currentUserId != ''">
            LEFT JOIN t_test_system_user tsu ON tsu.SYSTEM_ID = b.SYSTEM_ID AND tsu.USER_ID = #{currentUserId}
            LEFT JOIN tf_bug_role_permission brp ON brp.USER_ID = #{currentUserId} AND brp.TEST_LEADER = '1'
        </if>
        WHERE 1 = 1
        <if test="queryType != null and queryType == 'myActiveBugs' and currentUserId != null and currentUserId != ''">
            AND (
                b.SUBMITTER_ID = #{currentUserId}
                OR b.DEVELOPER_ID = #{currentUserId}
                OR b.DEV_LEADER_ID = #{currentUserId}
                OR b.CHECKER_ID = #{currentUserId}
                OR (
                    (b.BUG_STATE = 'Submitted' OR b.BUG_STATE = 'ReSubmitted')
                    AND brp.ROLE_PERMISSION_ID IS NOT NULL
                    AND tsu.SYSTEM_USER_ID IS NOT NULL
                )
            )
            AND b.BUG_STATE NOT IN ('BackClosed', 'Invalid', 'Closed')
        </if>
        <include refid="CommonCondition" />
        ORDER BY b.COMMIT_TIME DESC
    </select>

    <!-- 根据缺陷ID获取缺陷详情 -->
    <select id="selectBugDetailById" resultType="com.king.test.bugManage.entity.TfBug">
        SELECT
            b.BUG_ID AS bugId,
            b.BUG_NAME AS bugName,
            b.SYSTEM_ID AS systemId,
            ts.SYSTEM_NAME AS systemName,
            b.BUG_STATE AS bugState,
            bs.BUG_STATE_NAME AS bugStateName,
            b.USECASE_ID AS usecaseId,
            b.BUG_SOURCE AS bugSource,
            dic_source.DATA_NAME AS bugSourceName,
            b.PRORITY AS prority,
            dic_priority.DATA_NAME AS prorityName,
            b.BUG_DESCRIPITION AS bugDescription,
            b.BUG_SEVERITY_LEVEL AS bugSeverityLevel,
            dic_severity.DATA_NAME AS bugSeverityLevelName,
            b.CLOSE_REASON AS closeReason,
            b.SUBMITTER_ID AS submitterId,
            submitter.USER_NAME AS submitterName,
            b.DEVELOPER_ID AS developerId,
            developer.USER_NAME AS developerName,
            b.DEV_LEADER_ID AS devLeaderId,
            dev_leader.USER_NAME AS devLeaderName,
            b.CHECKER_ID AS checkerId,
            checker.USER_NAME AS checkerName,
            b.BUG_TYPE AS bugType,
            dic_type.DATA_NAME AS bugTypeName,
            b.DIRECTORY_ID AS directoryId,
            b.COMMIT_TIME AS commitTime,
            b.CONFIRMED_TIME AS confirmedTime,
            b.ASSIGNED_TIME AS assignedTime,
            b.RESOLVED_TIME AS resolvedTime,
            b.WAITCHECK_TIME AS waitCheckTime,
            b.CLOSE_TIME AS closeTime,
            b.SOLVE_VOLUME AS solveVolume,
            b.SUBMITTED_VOLUME AS submittedVolume,
            b.BUG_WORKFLOW_ID AS bugWorkflowId
        FROM tf_bug b
        LEFT JOIN t_test_system ts ON b.SYSTEM_ID = ts.SYSTEM_ID
        LEFT JOIN t_sys_user submitter ON b.SUBMITTER_ID = submitter.USER_ID
        LEFT JOIN t_sys_user developer ON b.DEVELOPER_ID = developer.USER_ID
        LEFT JOIN t_sys_user dev_leader ON b.DEV_LEADER_ID = dev_leader.USER_ID
        LEFT JOIN t_sys_user checker ON b.CHECKER_ID = checker.USER_ID
        LEFT JOIN tf_bug_state bs ON bs.BUG_STATE_CODE = b.BUG_STATE
        LEFT JOIN data_dictionary dic_source ON dic_source.DATA_TYPE = 'bugSource' AND dic_source.DATA_VALUE = b.BUG_SOURCE
        LEFT JOIN data_dictionary dic_priority ON dic_priority.DATA_TYPE = 'prority' AND dic_priority.DATA_VALUE = b.PRORITY
        LEFT JOIN data_dictionary dic_severity ON dic_severity.DATA_TYPE = 'bugSeverityLevel' AND dic_severity.DATA_VALUE = CAST(b.BUG_SEVERITY_LEVEL AS CHAR)
        LEFT JOIN data_dictionary dic_type ON dic_type.DATA_TYPE = 'bugType' AND dic_type.DATA_VALUE = b.BUG_TYPE
        WHERE b.BUG_ID = #{bugId}
        LIMIT 1
    </select>

    <!-- 查询缺陷列表用于导出 -->
    <select id="selectBugsForExport" resultType="com.king.test.bugManage.entity.TfBug">
        SELECT
            b.BUG_ID AS bugId,
            b.BUG_NAME AS bugName,
            b.SYSTEM_ID AS systemId,
            ts.SYSTEM_NAME AS systemName,
            b.BUG_STATE AS bugState,
            bs.BUG_STATE_NAME AS bugStateName,
            b.USECASE_ID AS usecaseId,
            b.BUG_SOURCE AS bugSource,
            dic_source.DATA_NAME AS bugSourceName,
            b.PRORITY AS prority,
            dic_priority.DATA_NAME AS prorityName,
            b.BUG_DESCRIPITION AS bugDescription,
            b.BUG_SEVERITY_LEVEL AS bugSeverityLevel,
            dic_severity.DATA_NAME AS bugSeverityLevelName,
            b.CLOSE_REASON AS closeReason,
            b.SUBMITTER_ID AS submitterId,
            submitter.USER_NAME AS submitterName,
            b.DEVELOPER_ID AS developerId,
            developer.USER_NAME AS developerName,
            b.DEV_LEADER_ID AS devLeaderId,
            dev_leader.USER_NAME AS devLeaderName,
            b.CHECKER_ID AS checkerId,
            checker.USER_NAME AS checkerName,
            b.BUG_TYPE AS bugType,
            dic_type.DATA_NAME AS bugTypeName,
            b.DIRECTORY_ID AS directoryId,
            b.COMMIT_TIME AS commitTime,
            b.CONFIRMED_TIME AS confirmedTime,
            b.ASSIGNED_TIME AS assignedTime,
            b.RESOLVED_TIME AS resolvedTime,
            b.WAITCHECK_TIME AS waitCheckTime,
            b.CLOSE_TIME AS closeTime,
            b.SOLVE_VOLUME AS solveVolume,
            b.SUBMITTED_VOLUME AS submittedVolume,
            b.BUG_WORKFLOW_ID AS bugWorkflowId
        FROM tf_bug b
        LEFT JOIN t_test_system ts ON b.SYSTEM_ID = ts.SYSTEM_ID
        LEFT JOIN t_sys_user submitter ON b.SUBMITTER_ID = submitter.USER_ID
        LEFT JOIN t_sys_user developer ON b.DEVELOPER_ID = developer.USER_ID
        LEFT JOIN t_sys_user dev_leader ON b.DEV_LEADER_ID = dev_leader.USER_ID
        LEFT JOIN t_sys_user checker ON b.CHECKER_ID = checker.USER_ID
        LEFT JOIN tf_bug_state bs ON bs.BUG_STATE_CODE = b.BUG_STATE
        LEFT JOIN data_dictionary dic_source ON dic_source.DATA_TYPE = 'bugSource' AND dic_source.DATA_VALUE = b.BUG_SOURCE
        LEFT JOIN data_dictionary dic_priority ON dic_priority.DATA_TYPE = 'prority' AND dic_priority.DATA_VALUE = b.PRORITY
        LEFT JOIN data_dictionary dic_severity ON dic_severity.DATA_TYPE = 'bugSeverityLevel' AND dic_severity.DATA_VALUE = CAST(b.BUG_SEVERITY_LEVEL AS CHAR)
        LEFT JOIN data_dictionary dic_type ON dic_type.DATA_TYPE = 'bugType' AND dic_type.DATA_VALUE = b.BUG_TYPE
        WHERE 1 = 1
        <include refid="CommonCondition" />
        ORDER BY b.COMMIT_TIME DESC
    </select>

    <!-- 分页查询关联的缺陷列表 -->
    <select id="selectPageRelatedBugs" resultType="com.king.test.bugManage.entity.TfBug">
        SELECT
            b.BUG_ID AS bugId,
            b.BUG_NAME AS bugName,
            b.SYSTEM_ID AS systemId,
            ts.SYSTEM_NAME AS systemName,
            b.BUG_STATE AS bugState,
            bs.BUG_STATE_NAME AS bugStateName,
            b.USECASE_ID AS usecaseId,
            b.BUG_SOURCE AS bugSource,
            dic_source.DATA_NAME AS bugSourceName,
            b.PRORITY AS prority,
            dic_priority.DATA_NAME AS prorityName,
            b.BUG_DESCRIPITION AS bugDescription,
            b.BUG_SEVERITY_LEVEL AS bugSeverityLevel,
            dic_severity.DATA_NAME AS bugSeverityLevelName,
            b.CLOSE_REASON AS closeReason,
            b.SUBMITTER_ID AS submitterId,
            submitter.USER_NAME AS submitterName,
            b.DEVELOPER_ID AS developerId,
            developer.USER_NAME AS developerName,
            b.DEV_LEADER_ID AS devLeaderId,
            dev_leader.USER_NAME AS devLeaderName,
            b.CHECKER_ID AS checkerId,
            checker.USER_NAME AS checkerName,
            b.BUG_TYPE AS bugType,
            dic_type.DATA_NAME AS bugTypeName,
            b.DIRECTORY_ID AS directoryId,
            b.COMMIT_TIME AS commitTime,
            b.CONFIRMED_TIME AS confirmedTime,
            b.ASSIGNED_TIME AS assignedTime,
            b.RESOLVED_TIME AS resolvedTime,
            b.WAITCHECK_TIME AS waitCheckTime,
            b.CLOSE_TIME AS closeTime,
            b.SOLVE_VOLUME AS solveVolume,
            b.SUBMITTED_VOLUME AS submittedVolume,
            b.BUG_WORKFLOW_ID AS bugWorkflowId
        FROM tf_bug b
        LEFT JOIN t_test_system ts ON b.SYSTEM_ID = ts.SYSTEM_ID
        LEFT JOIN t_sys_user submitter ON b.SUBMITTER_ID = submitter.USER_ID
        LEFT JOIN t_sys_user developer ON b.DEVELOPER_ID = developer.USER_ID
        LEFT JOIN t_sys_user dev_leader ON b.DEV_LEADER_ID = dev_leader.USER_ID
        LEFT JOIN t_sys_user checker ON b.CHECKER_ID = checker.USER_ID
        LEFT JOIN tf_bug_state bs ON bs.BUG_STATE_CODE = b.BUG_STATE
        LEFT JOIN data_dictionary dic_source ON dic_source.DATA_TYPE = 'bugSource' AND dic_source.DATA_VALUE = b.BUG_SOURCE
        LEFT JOIN data_dictionary dic_priority ON dic_priority.DATA_TYPE = 'prority' AND dic_priority.DATA_VALUE = b.PRORITY
        LEFT JOIN data_dictionary dic_severity ON dic_severity.DATA_TYPE = 'bugSeverityLevel' AND dic_severity.DATA_VALUE = CAST(b.BUG_SEVERITY_LEVEL AS CHAR)
        LEFT JOIN data_dictionary dic_type ON dic_type.DATA_TYPE = 'bugType' AND dic_type.DATA_VALUE = b.BUG_TYPE
        WHERE 1 = 1
        <if test="usecaseId != null and usecaseId != ''">
            AND b.USECASE_ID = #{usecaseId}
        </if>
        <if test="directoryId != null and directoryId != ''">
            AND CAST(b.DIRECTORY_ID AS CHAR) = #{directoryId}
        </if>
        ORDER BY b.COMMIT_TIME DESC
    </select>

    <!-- 根据系统ID查询开发组长列表 -->
    <select id="selectDevLeadersBySystemId" resultType="com.king.sys.user.entity.TSysUser">
        SELECT DISTINCT
            u.USER_ID AS userId,
            u.LOGIN_NAME AS loginName,
            u.USER_NAME AS userName,
            u.EMAIL AS email,
            u.PHONE AS phone,
            u.ORG_ID AS orgId,
            u.STATUS AS status,
            u.SORT_NO AS sortNo
        FROM t_test_system_user tsu
        INNER JOIN tf_bug_role_permission brp ON tsu.USER_ID = brp.USER_ID
        INNER JOIN t_sys_user u ON tsu.USER_ID = u.USER_ID
        WHERE tsu.SYSTEM_ID = #{systemId}
          AND brp.DEV_LEADER = '1'
          AND u.STATUS = 1
        ORDER BY u.SORT_NO ASC, u.USER_NAME ASC
    </select>

    <!-- 根据系统ID查询开发人员列表 -->
    <select id="selectDevelopersBySystemId" resultType="com.king.sys.user.entity.TSysUser">
        SELECT DISTINCT
            u.USER_ID AS userId,
            u.LOGIN_NAME AS loginName,
            u.USER_NAME AS userName,
            u.EMAIL AS email,
            u.PHONE AS phone,
            u.ORG_ID AS orgId,
            u.STATUS AS status,
            u.SORT_NO AS sortNo
        FROM t_test_system_user tsu
        INNER JOIN t_sys_role_user ru ON tsu.USER_ID = ru.USER_ID
        INNER JOIN t_sys_user u ON tsu.USER_ID = u.USER_ID
        WHERE tsu.SYSTEM_ID = #{systemId}
          AND ru.ROLE_ID = '0001'
          AND u.STATUS = 1
        ORDER BY u.SORT_NO ASC, u.USER_NAME ASC
    </select>

    <!-- 根据系统ID查询验证人列表 -->
    <select id="selectCheckersBySystemId" resultType="com.king.sys.user.entity.TSysUser">
        SELECT DISTINCT
            u.USER_ID AS userId,
            u.LOGIN_NAME AS loginName,
            u.USER_NAME AS userName,
            u.EMAIL AS email,
            u.PHONE AS phone,
            u.ORG_ID AS orgId,
            u.STATUS AS status,
            u.SORT_NO AS sortNo
        FROM t_test_system_user tsu
        INNER JOIN t_sys_role_user ru ON tsu.USER_ID = ru.USER_ID
        INNER JOIN t_sys_user u ON tsu.USER_ID = u.USER_ID
        WHERE tsu.SYSTEM_ID = #{systemId}
          AND ru.ROLE_ID = '0002'
          AND u.STATUS = 1
        ORDER BY u.SORT_NO ASC, u.USER_NAME ASC
    </select>

</mapper>
