<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.king.statistics.configurationStat.mapper.ConfigurationStatMapper">

    <!-- 查询各系统发版数统计 -->
    <select id="selectDeployBySysStat" resultType="com.king.statistics.configurationStat.dto.DeployBySysStatDTO">
        SELECT
            COALESCE(ts.SYSTEM_NAME, '未知系统') AS systemName,
            COUNT(CASE WHEN dr.TEST_STAGE = 'SIT' THEN 1 END) AS sitCount,
            COUNT(CASE WHEN dr.TEST_STAGE = 'PAT' THEN 1 END) AS patCount
        FROM tf_deploy_record dr
        LEFT JOIN t_test_system ts ON dr.SYSTEM_ID = ts.SYSTEM_ID
        <where>
            <if test="startDate != null and startDate != ''">
                AND DATE(dr.DEPLOY_TIME) &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND DATE(dr.DEPLOY_TIME) &lt;= #{endDate}
            </if>
            <if test="systemId != null and systemId != ''">
                AND dr.SYSTEM_ID = #{systemId}
            </if>
        </where>
        GROUP BY dr.SYSTEM_ID, ts.SYSTEM_NAME
        ORDER BY ts.SYSTEM_NAME
    </select>

</mapper>
